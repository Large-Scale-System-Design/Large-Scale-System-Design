## 6주차. 안정 해시 설계

<br>

## 1\. 해시 목적

- 수평적 규모 확장성을 위해서는 → 데이터를 서버에 균등하게 나누는 것이 중요함.
- 안정 해시는 이를 위한 기술

<br>

### 1.1. 해시 키 재배치 문제

- 보편적인 해시값 배분을 위한 식
    - 인덱스 = 해시값 % N (N: 서버 개수)
    - 여기서 서버가 추가 혹은 삭제될 경우, 인덱스 값이 달라짐.
        - 키가 재분배되면서 엉뚱한 서버로 접속하여 캐시 미스가 발생

- 안정해시는 이러한 해시 키 재배치 문제를 해결하기 위한 방법

<br>

### 안정 해시 

1. **해시 링 구성**

- 2^N -1 까지의 숫자로 이루어진 거대한 원형 고리(Ring)에 
    - 각 서버(예: 서버 A, B, C)의 고유한 이름이나 IP 주소를 해시 함수로 계산
    - 서버 고유 식별 정보의 해시 값을 링 위의 해당 위치에 점처럼 배치합니다.

- 저장하려는 데이터의 키(Key) 역시 동일한 해시 함수로 계산하여 링 위에 배치
    - 키를 배치하고 시계방향으로 이동하면서, 가장 먼저 만나는 서버가 해당 키를 담당하는 서버

- Scale Out(서버 수 추가) 시
    - 서버 D가 추가되었을 때 A → B → C → A 에서 A → B → **C → D** → A  이런식으로 C와 A 사이에 추가되었을 때
        - 서버 C와 A 사이의 키 중 → C → D 사이에 있었던 키만 영향을 받게 되고
        - A → B → C 사이 + D → A 사이의 키는 영향을 받지 않음

- Scale In(서버 수 감소) 시
    - 서버 B가 사라졌을 때 A → B → C → 에서 A → C → A 이런식으로 B가 사라질 경우
        - 원래 B 가 담당하던 키는 → C가 담당하게 되고, 서버 A와 서버 C에 존재하는 데이터는 재배치되지 않음

- 결론: 안정 해시도 완벽하게 재배치를 막지는 못하지만, 최소화

<br>

### 1.2. 기본 구현법의 두가지 문제

1. 서버 추가 삭제 될 때, 파티션의 크기를 균등하게 유지하는 것이 불가능하다.
    - A → B → C → D → A 로 4분할로 균등하게 배치해놓고
    - D가 없어질 경우 → A에 배정된 크기가 많아짐.
2. 키의 균등 분포를 달성하기 어렵다.
    - 파티션이 균등하지 않기 때문에 어느 한쪽의 파티션에 키가 몰릴 경우 키가 균등하게 분포되지 않음

<br>

### 1.3. 이러한 문제를 해결하기 위한 방법

1. 가상 노드
    - 하나의 물리적인 서버에 대해 여러 가상노드로 배치
        - A 서버에 대해 A0 A1 A2 등등등
        - 이러한 가상 노드들을 각각 다른 해시값을 갖게 하여 여러 위치에 분산시켜 놓음

    - 물리 서버가 3개여도 가상 노드를 100개씩 배치하면 → 300개의 노드가 균등하게 배치되는 효과
    - 가상 노드의 개수를 늘림으로써, 표준 편차를 줄여 데이터를 고르게 분포하는 방법
    - 장점
        - 데이터 균등 분배: 노드가 링 전체에 훨씬 더 촘촘하고 균일하게 분포되어 데이터가 여러 서버에 고르게 분산됩
        - **장애 영향 분산: A 서버가 다운되더라도, A가 담당하던 데이터를 B로 모두 넣는게 아니라 B, C의 각각 가상노드로 편재되어 이관됨. (단 하나의 서버에서 장애를 떠맡지 않음)**

**<br>
**

### **1.4. 안정 해시의 이점(목적)**

- **서버가 추가되거나 삭제될 때, 재배치되는 키의 수를 최소화**
- **데이터를 최대한 균등하게 배치하여 수평적 규모 확장을 달성**
- **특정 서버에 부하가 몰리는 “핫스팟” 키 문제를 줄인다.**

**<br>
**

**균등하게 데이터를 분포시키는게 최대의 목적**

**(1주차에 이것과 비슷한 내용이 샤딩에 있었음)**

**![](Files/image.png)<br>
**

**<br>
**

**<br>
**

### **1.5. 안정 해시를 쓰는 대표적인 기술들**

- **AWS DynamoDB**
- **Apache Cassandra**
- **Discord (?) Chatting Application**
- **Akamai CDN (?)**
- **Meglev 네트워크 부하 분산기 (?)**

> GPT 첨언  
> 안정 해시는 서버의 추가와 삭제가 빈번하게 일어나거나, 데이터의 균등한 분배가 중요한 거의 모든 분산 시스템에서 사용됩니다.
> 
> - **분산 캐시 (Distributed Caches):** **Memcached**, **Redis Cluster** 등에서 캐시 서버가 추가/삭제될 때 전체 캐시가 무효화되는 것을 방지합니다.
> - **NoSQL 데이터베이스:** **Amazon DynamoDB**, **Apache Cassandra**, **Riak** 등에서 데이터를 여러 노드에 분산 저장하고 파티셔닝(Partitioning)하는 핵심 기술로 사용됩니다.
> - **분산 해시 테이블 (DHTs):** P2P 네트워크(예: BitTorrent)에서 특정 데이터를 어떤 피어(Peer)가 가지고 있는지 찾는 데 사용됩니다.
> - **로드 밸런서:** 일부 로드 밸런서는 클라이언트의 세션 정보를 특정 서버에 고정(Sticky Session)시킬 때, 서버 풀(Pool)이 변경되어도 세션 유지를 돕기 위해 안정 해시를 사용하기도 합니다.

### <br>

### 1.6. 과제로 해보고 싶은 내용

- 안정 해시 기술 이용해서 Sticky Session N 중화 서버 구현하기

**<br>
**

### 1.7. 과제

- 서버 3대
    - session id
        - 1 → A
        - 2 → B
        - 3 → C
        - 4 → C
    - 서버 1대 추가
        - **1 → A**
        - **2 → B**
        - **3 → C (원래는 4에 대한 정보가 여기 있음)**
        - **4 → D (캐시 미스)**

**<br>
**

**<br>
**

**<br>
**

**<br>
**