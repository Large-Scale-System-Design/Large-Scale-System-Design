# 12.  채팅 시스템 설계
- 주요 설계 내용
    - 응답 지연 최소화, 일대일 채팅
    - 그룹 채팅(최대 100명)
    - 사용자 접속 상태 표시
    - 여러 단말 동시 접속 가능
    - 푸시 알림

<br>

1. 요구사항 정의
    - 일별 능동자 수(DAU: Daily Active User) 5천만명
    - 채팅 인원: 최대 100명
    - 메시지 길이 제한 등
    - 종단 간 암호화 여부
    - 채팅 이력 보존 기간: 영구
    - 등등
2. 개략적 설계
    - 클라이언트는 직접 통신하지 않음 / 채팅 서버와 통신
    - 과정
        - 클라이언트 메시지 수신
        - 메시지 수신자 결정 및 전달
        - 접속상태가 아닌 경우, 접속할 때까지 메시지 보관
    - 메시지 송신 프로토콜: HTTP
    - 메시지 수신 프로토콜
        - 폴링
            - 클라이언트가 주기적으로 서버에 새 메시지가 있는지 물어보는 방법 (자주할수록 비용 높음)
        - 롱 폴링
            - 새 메시지가 반환되거나 타임아웃될 때까지 연결 유지
            - 새로운 메시지를 받으면 기존 연결을 종료하고 서버에 새로운 요청을 보내어 모든 절차를 다시 시작
                - 약점
                    - 메시지를 받은 서버는 해당 메시지를 수신할 클라이언트와 롱 폴링 연결을 가지고 있지 않은 서버일 수 있음
                    - 서버입장에서 연결을 해제했는지 아닌지 알 좋은 방법이 없음
                    - 타임아웃이 일어날때마다 다시 접속 시도, 메시지를 받아도 새로운 접속 시도 (비효율)

        - 웹 소켓
            - 클라이언트에게 비동기 메시지 전송 가능
            - 처음에는 HTTP 연결이지만, 핸드셰이크 절차를 거쳐 웹소켓 연결로 업그레이드
            - 연결이 만들어지고 나면, 서버는 클라이언트에게 비동기적으로 메시지를 전송할 수 있음
            - HTTP(S) 프로토콜 포트를 그대로 사용하기 때문에 방화벽에도 문제 없음
        - 결론
            - 상태 유지 서비스(Stateful): 클라이언트와 서버가 독립적인 연결을 유지 → 웹소켓
            - 푸시 알림
            - 규모 확장성(당연한 얘기)
            - 저장소: 키-값 저장소 → 지연시간이 낮음
                - 관계형DB는 롱 테일에 해당하는 부분을 잘 처리하지 못하고, 인덱스가 커지면 데이터에 대한 무작위적 접근을 처리하는 비용이 늘어남
            - 메시지ID: snowflake 기법으로, 시간순으로 id 가 오름차순되게끔

3. 상세 설계
    - 클라이언트의 위치, 서버의 용량 등을 토대로 어떤 채팅 서버로 연결할 지
    - 메시지 흐름
        - 사용자 A가 채팅 서버 1로 메시지 전송
        - 채팅 서버 1은 메시지 ID 선정
        - 채팅 서버 1은 메세지를 동기화 큐로 전송
        - 메시지가 키-값 저장소에 보관
        - 사용자 B가 접속 중인 경우, B가 접속중인 서버로 메시지 전송
        - 사용자 B가 접속 중이 아닌 경우, 푸시 알림 메시지를 푸시 알림 서버로 전송
        - 채팅 서버 2는 메시지를 사용자 B에게 전송(사용자B-채팅서버2에는 웹소켓이 기존에 연결된 상태임)
    - 여러 단말 간 메시지 동기화
        - 해당 단말에서 받은 가장큰 메시지ID 를 가지고 있다가, 그보다 큰 ID를 가진 메시지를 전달받으면 됨
    - 그룹 채팅
        - 사용자마다 메시지 큐를 두고 각각 채팅 메시지를 삽입
    - 접속 상태 표시
        - heartbeat 방식을 통해서 클라이언트가 주기적으로 서버에 접속 상태를 전송
        - 부하를 줄이기 위해, pub-sub 대신 수동으로 동기화할수있도록

4. 부가 설계
    - 미디어 전송 방법
    - 종단 간 암호화
    - 캐시
    - 로딩 속도 개선
    - 오류 처리
        - 채팅 서버 오류
        - 메시지 재시도