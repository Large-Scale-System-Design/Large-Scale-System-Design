# 주제
- 11장: 뉴스 피드 시스템 설계
# 내용
## 개요
- 뉴스 피드: 홈 페이지 중앙에 지속적으로 업데이트되는 스토리
	- 사용자 상태 정보 업데이트
	- 사진
	- 비디오
	- 링크
	- 앱 활동
	- 팔로우
	- 페이지
	- 좋아요
## 1. 문제 이해 및 설계 범위 확정
- 플랫폼: 모바일 앱 / 웹 지원
- 주요 기능: 스토리 업로드 / 친구 스토리 확인
- 스토리 표시 순서: 단순 시간 역순 표시
- 친구 보유수: 5000명
- 트래픽 규모: 매일 천만 명
- 컨텐츠 유형: 이미지 / 비디오 등 미디어 파일 포함
## 2. 개략적 설계안 제시 및 동의 구하기
- 피드 발행: 사용자가 스토리 포스팅 시, 해당 데이터를 캐시, 데이터베이스에 기록 및 친구 뉴스 피드에 전송
- 뉴스 피드 생성: 모든 친구의 포스팅을 시간 흐름 역순으로 모아서 생성
### 뉴스 피드 API
- HTTP 프로토콜 기반으로 상태 정보 업데이트, 뉴스 피드 가져오기, 친구 추가 등 다양한 작업 수행 시 사용
#### 피드 발행 API
- 새 스토리를 포스팅하기 위한 API
- API 형태: `POST /v1/me/feed`
	- 바디: 포스팅 내용
	- Authorization 헤더: API 호출 인증
#### 피드 읽기 API
- 뉴스 피드를 가져오는 API
- API 형태: `GET /v1/me/feed`
	- Authorization 헤더: API 호출 인증
### 피드 발행
- 사용자: 모바일 앱, 브라우저에서 새 포스팅을 올리는 주체. `POST /v1/me/feed` API 사용
- 로드밸런서: 트래픽을 웹 서버들로 분산
- 웹 서버: HTTP 요청을 내부 서비스로 중계하는 역할
- 포스팅 저장 서비스: 새 포스팅을 데이터베이스와 캐시에 저장
- 포스팅 전송 서비스: 새 포스팅을 친구의 뉴스 피드에 푸시. 뉴스 피드 데이터는 캐시에 보관하여 빠르게 읽도록 함
- 알림 서비스: 친구들에게 새 포스팅 업로드를 알리거나, 푸시 알림 전송 역할
### 뉴스 피드 생성
- 사용자: 뉴스 피드를 읽는 주체. `GET /v1/me/feed` API 사용
- 로드밸런서: 트래픽을 웹 서버들로 분산
- 웹 서버: 트래픽을 뉴스 피드 서비스로 전달
- 뉴스 피드 서비스: 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시: 뉴스 피드 렌더링 시 필요한 뉴스 피드 ID 보관
## 3. 상세 설계
### 피드 발행 흐름 상세 설계
#### 웹 서버
- 클라이언트 통신, 인증, 처리율 제한 기능 수행
- 올바른 인증 토큰을 Authorization 헤더에 포함하여 API를 호출하는 사용자만 포스팅 가능
- 스팸 방지 및 유해 컨텐츠 방지를 위해 특정 기간 동안 한 사용자가 올릴 수 있는 포스팅 수 제한
#### 포스팅 전송(팬아웃) 서비스
- 사용자의 새 포스팅을 친구 관계에 있는 모든 사용자에게 전달하는 과정
##### 팬아웃 모델
- 쓰기 시점에 팬아웃 모델: 새로운 포스팅을 기록하는 시점에 바로 해당 사용자의 캐시에 해당 포스팅을 기록하여 뉴스 피드 갱신
	- 장점
		- 뉴스 피드가 실시간 갱신되어 친구 목록에 있는 사용자에게 즉시 전송
		- 새 포스팅 기록 즉시 뉴스 피드가 이미 갱신되어, 뉴스 피드를 읽는 시간 감소
	- 단점
		- 친구가 많은 사용자의 경우, 친구 목록을 가져와서 그 목록에 있는 사용자 모두의 뉴스 피드를 갱신하는 데 많은 시간 소요 (핫키 문제)
		- 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신되어 컴퓨팅 자원 낭비
- 읽기 시점에 팬아웃 모델: 피드를 읽는 시점에 뉴스 피드 갱신(요청 기반 모델). 사용자가 본인 홈페이지나 타임라인을 로디하는 시점에 새로운 포스트를 가져옴
	- 장점
		- 비활성화된 사용자 또는 서비스에 거의 로그인하지 않는 사용자의 경우, 로그인 전까지 어떤 컴퓨팅 자원도 소모하지 않아서 이 모델이 유리
		- 데이터를 친구 각각에 푸시하는 작업이 필요 없으므로 핫키 문제 없음
	- 단점
		- 뉴스 피드를 읽는 데 많은 시간 소요
#### 최종 설계
- 두 가지의 팬아웃 모델을 결합하여 장점만 취함
- 대부분의 사용자는 푸시 모델 사용, 친구나 팔로워가 아주 많은 사용자는 풀 모델 사용
<img src="./docs/image1.png">

#### 동작 방식
1. 그래프 데이터베이스에서 친구 ID 목록 조회
2. 사용자 정보 캐시에서 친구 목록 조회 / 친구 필터링(피드 업데이트 무시 설정 반영)
3. 친구 목록 및 새 스토리의 포스팅 ID를 메시지 큐에 삽입
4. 메시지 큐 데이터를 꺼내어, 뉴스 피드 데이터를 뉴스 피드 캐시에 삽입 (포스팅 ID, 사용자 ID 매핑 테이블 갱신)
	- 캐시 크기 제한 및 제한 설정 제공
### 피드 읽기 흐름 상세 설계
<img src="./docs/image2.png">

#### 동작 방식
1. 사용자가 뉴스 피드 읽기 요청 전송 (`GET /v1/me/feed`)
2. 로드밸런서가 요청을 웹 서버 중 하나에 전달
3. 웹 서버는 피드를 가져오기 위해 뉴스 피드 서비스 호출
4. 뉴스 피드 서비스는 뉴스 피드 캐시에서 포스팅 ID 목록 획득
5. 뉴스 피드에 표시할 데이터를 사용자 캐시 / 포스팅 캐시에서 가져와서 완벽한 뉴스 피드 생성
	- 사용자 이름
	- 사용자 사진
	- 포스팅 컨텐츠
	- 이미지
6. 생성된 뉴스 피드를 JSON 형태로 클라이언트에 전달, 클라이언트는 해당 피드 렌더링 수행
#### 캐시 구조
- 뉴스 피드 시스템의 캐시는 5계층으로 구성

| 유형     | 항목                | 설명                              |
| ------ | ----------------- | ------------------------------- |
| 뉴스 피드  | 뉴스 피드(ID)         |                                 |
| 컨텐츠    | 인기 컨텐츠, 일반 컨텐츠    | - 포스팅 데이터 보관<br>- 인기 컨텐츠는 별도 보관 |
| 소셜 그래프 | 팔로워, 팔로잉          | - 사용자 간 관계 정보 보관                |
| 행동     | 좋아요, 답글, 기타       | - 포스팅에 대한 사용자의 행위에 관한 정보 보관     |
| 횟수     | 좋아요 횟수, 답글 횟수, 기타 |                                 |
## 4. 마무리
- 시스템 설계 시, 회사마다 독특한 제약이나 요구조건 고려 필요
- 설계 진행 및 기술 선택 시, 어떤 타협적 결정들이 있었는지 이해 및 설명 필요
### 확장성 논의
- 데이터베이스 규모 확장
	- 수직적 규모 확장 vs 수평적 규모 확장
	- SQL vs NoSQL
	- master-slave 다중화
	- 복제본에 대한 읽기 연산
	- 일관성 모델
	- 데이터베이스 샤딩
- 웹 계층 무상태 운영
- 가능한 한 많은 데이터를 캐싱하는 방법
- 다중 데이터 센터 지원
- 메시지 큐를 통한 컴포넌트 사이 결합도 낮추기
- 핵심 메트릭 모니터링
	- 트래픽 집중 시간대 QPS
	- 사용자 뉴스 피드 새로고침 지연시간
