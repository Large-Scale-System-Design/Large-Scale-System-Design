이번 장에서는 알림 시스템을 개략적 설계한 후, 추가적으로 고려해야할 사항 등을 포함하여 상세 설계하는 법에 대해서 알아보려고 한다.

(알림시스템은 모바일 푸시 알림, SMS 메시지, 이메일 3가지로 분류)

#### 1\. 연락처 정보 수집 절차

\- 알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요

\- 앱을 설치하거나 계정을 등록할 때, API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장

#### 2\. 개략적 설계안(고려해야 할 내용들)

-   서비스: 쇼핑몰 웹사이트 등 알림을 보내는 서비스로 마이크로서비스, 크론잡, 분산 시스템일 수 있음
-   림 시스템: 알림 전송을 위한 API 제공, 알림 페이로드(payload)를 만들어낼 수 있어야 함
-   제3자 서비스: 사용자에게 알림을 실제로 전달하는 역할
    -   확장성 고려: 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 함
    -   특정 써드파티 제품은 어떤 나라에서 사용할 수 없는 경우가 있음 (ex. 중국에서는 FCM 사용이 불가하고 Jpush, PushY 서비스를 사용)
-   수신자 단말: iOS, Androiod
-   SPOF: 알림 서비스에 서버가 1대밖에 없다면, 하나의 장애가 전체 서비스의 장애로 이어질 수 있음
-   규모 확장성: 마찬가지로 1대 서버밖에 없다면, 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다
-   성능 병목: 트래픽이 많이 몰리는 시간에는 시스템이 과부하 상태에 빠질 수 있음

#### 3\. 개략적 설계

-   데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리
-   알림 서버를 증설하고 오토스케일링이 이루어질 수 있도록 함
-   메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊음
-    알림 시스템
    -   알림 전송 API: 인증된 클라이언트만 이용 가능한 알림 전송 인터페이스 제공
    -   알림 검증: 이메일 주소, 전화번호 등에 대한 기본적 검증 수행
    -   데이터베이스 / 캐시 질의: 알림에 포함시킬 데이터를 가져오는 기능
    -   알림 전송: 알림 데이터를 메시지 큐에 넣고 병렬적으로 알림을 처리
-   캐시: 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시
-   DB: 사용자, 알림, 설정 등 다양한 정보를 저장
-   메시지 큐: 시스템 컴포넌트 간 의존성을 제거하기 위해 사용 (다량의 알림이 전송되어 하는 경우를 대비한 버퍼 역할)
-   작업 서버: 메시키 쥬에서 전송할 알림을 꺼내서 제 3자 서비스로 전달하는 역할을 담당
-   3rd party 제품들: 실제 알림 전송

#### 4\. 상세 설계

-   안정성
    -   데이터 손실 방지: 어떠한 상황에서도 알림이 소실되면 안된다. 알림이 지연되거나 순서가 틀려도 괜찮지만, 사라지면 안된다. 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다. (알림 로그 데이터베이스 사용하는 것도 한가지 방법)
-   알림 중복 전송 방지: 같은 알림이 여러 번 반복되는 것을 완전히 막는 것은 불가능하지만, 중복을 탐지하는 매커니즘을 도입하고 오류를 신중하게 처리해야 함  
    (보내야 할 알림이 도착하면, 그 이벤트 ID를 검사하여 이전에 본 적이 있는 이벤트인지 확인하여 중복 전송을 방지한다)  
      
    
-   추가로 필요한 컴포넌트 및 고려사항
    -   알림 템플릿: 대형 알림 시스템에서는 메시지 형식이 대부분 비슷하다. 알림 템플릿을 이용해서 파라미터, 스타일, 링크 등을 조정하기만 하도록 알람 틀을 만든다  
        (ex. 제목: \[!title\], 내용: \[!item\_name\]이 재입고 되었으며 배송 예정일은 \[!date\] 이후 도착합니다. 등)
    -   알림 설정: 사용자가 알림 설정을 상세히 조정가능해야 함
    -   전송률 제한: 사용자가 받을 수 있는 알림의 빈도를 제한한다. (너무 많은 아림을 보내면 사용자가 알림을 꺼버릴 수도 있다.)
    -   재시도 방법: 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣고 같은 문제가 계속해서 발생하면 개발자에게 경고(alert)
    -   푸시 알림과 보안: iOS나 Android 앱의 경우, API는 appKey와 appSecret을 사용하여 보안을 유지한다. 인증/인가에 성공한 클라이언트만 알림 API를 사용하여 알림을 보낼 수 있도록 해야함
    -   큐 모니터링: 메시지 큐에 쌓인 알림 개수를 모니터링
    -   이벤트 추적: 알림 확인율, 클릭율 같이 실제 앱 사용으로 이어지는 비율 메트릭 정보는 사용자를 이해하는데 중요하다. 따라서 데이터 분석 서비스와 통합해서 알림 시스템을 설계해야 함

#### 5\. 정리

-   안정성 측면
    -   오토 스케일링
    -   템플릿 적용 (알림 생성 과정 단순화)
    -   전송 실패에 대한 재시도 처리 (지정 횟수만큼 재시도 및 경고)
-   보안 측면
    -   알림 서버 API에 인증/인가 적용
-   이벤트 추적 및 모니터링 측면
    -   모니터링 / 추적 시스템
    -   데이터 분석 서비스와 통합하여 실제 클릭률/확인률 분석
-   사용자 편의 / 설정
    -   전송률 제한
    -   사용자가 알림 설정을 조정