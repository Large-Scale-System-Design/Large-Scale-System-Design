# 주제
- 8장 - URL 단축기 설계

# 내용
## 1. 문제 이해 및 설계 범위 확정
### 개략적 추정
- 쓰기 연산: 매일 1억 개의 단축 URL 생성
- 초당 쓰기 연산: 1억 / 24 / 3600 = 1160
- 읽기 연산: 읽기 연산과 쓰기 연산 비율은 10:1로 가정하여, 초당 11,600회 발생
- URL 단축 서비스 10년 운영 시, 3650억 개의 레코드 보관 필요
- 축약 전 URL의 평균 길이는 100
- 10년 동안 필요한 저장 용량은 3650억 * 100 바이트 = 36.5TB
## 2. 개략적 설계안 제시 및 동의 구하기
### API 엔드포인트
- 클라이언트는 RESTful 형태의 API 엔드포인트를 통해 서버와 통신
	1. URL 단축용 엔드포인트: 단축 URL 생성 대상 원본 URL을 POST로 요청
		- POST /api/v1/data/shorten
	2. URL 리다이렉션용 엔드포인트: 단축 URL 요청에 대한 원본 URL을 보내줌
		- GET /api/v1/shortUrl
### URL 리다이렉션
- 사용자의 단축 URL 접근에 대한 응답 시, Location 헤더에 원본 URL을 포함하여 리디렉션 전달
- 해시 테이블에 <단축 URL, 원본 URL> 쌍을 저장
#### 301: Permanently Moved
- 사용자 HTTP 요청이 영구적으로 Location 헤더에 반환된 URL로 이전되었다는 응답
- 영구적 이전이므로, 브라우저에서 응답 캐싱
- 이후 동일한 단축 URL 요청은 캐시를 통해 즉시 원본 URL로 요청 전달
- 장점: 브라우저 캐싱에 의해 서버 부담 저하
#### 302: Found
- 요청한 URL에 대해 일시적으로 Location 헤더에 지정된 URL에 의해 처리되어야 한다는 응답
- 클라이언트 요청은 항상 단축 URL 서버를 거친 후 원본 URL로 리디렉션 됨
- 장점: 항상 단축 URL 서버를 거치므로, 트래픽 분석에 용이
### URL 단축
- 원본 URL을 단축하기 위해 해시 함수 설계 필요
- 원본 URL값이 다르면 해시 값도 달라짐
- 계산된 해시 값은 원본 URL로 복원 가능

## 3. 상세 설계
### 데이터 모델
- RDBMS에 id, short_url, original_url 컬럼이 포함된 테이블 구성
### 해시 함수
- 원본 URL을 단축 URL로 변환하기 위해 사용
#### 해시값 길이
- 해시 함수에서 사용 가능한 값은 총 62개 (`[0-9, a-z, A-Z`)
- 3560억 이상의 값을 표현 가능한 62^n 에 대해 n의 최솟값은 7 (3.5조개)
#### 해시 후 충돌 해소
- CRC32, MD5, SHA-1 등의 잘 알려진 해시 함수 사용 방식
- 해시 값이 길 경우, 최초 7자 이후 해시 값 제외
- 잘라진 해시 값의 충돌 해소를 위해 사전 정의된 문자열을 덧붙여 해시값 재계산
- 단축 URL에 대한 원본 URL 조회 시, 최소 1회 이상의 DB 조회 필요
	- 블룸 필터를 통해서 완화는 가능함
#### base-62 변환
- 진법 변환을 통해 URL 단축 기능 제공

>[!info] 해시 함수 전략 비교

| 해시 후 충돌 해소 전략                               | base-62 변환                                           |
| ------------------------------------------- | ---------------------------------------------------- |
| 단축 URL의 길이가 고정됨                             | 단축 URL의 길이가 가변적. ID 값이 커지면 변환값도 길어짐                  |
| 유일성이 보장되는 ID 생성기 불필요                        | 유일성 보장 ID 생성기 필요                                     |
| 충돌 가능성으로 인해 충돌 해소 전략 필요                     | ID 유일성이 보장된 후에 적용 가능한 전략이므로, 충돌 불가                   |
| ID가 아닌 특정 규칙으로 계산된 URL이므로, 이후 생성될 URL 예측 불가 | ID가 1씩 증가한다고 가정 시, 이후 생성될 URL 예측이 가능하여 보안상 문제 소지가 있음 |
### URL 단축기 상세 설계
1. 원본 URL 수신
2. 단축 URL 정보 조회 (DB)
	- 조회 성공: 단축 URL 클라이언트로 전달
	- 조회 실패:
		1. 유일한 ID 생성 (분산 시스템을 위한 유일 ID 생성기 활용)
		2. ID를 62진법으로 변환
		3. DB에 ID, 단축 URL, 원본 URL 레코드 추가
		4. 단축 URL을 클라이언트에게 전달
### URL 리디렉션 상세 설계
- 전체 흐름: 사용자 -> 로드밸런서 -> 웹 서버 -> 캐시 / 데이터베이스
	1. 사용자가 단축 URL 클릭
	2. 로드밸런서가 웹 서버에 요청 전달
	3. 단축 URL 대상 캐시 조회
		- 캐시 존재: 원본 URL 리디렉션 응답 전달
		- 캐시 미존재
			1. 데이터베이스 조회
			2. 캐시 삽입
			3. 원본 URL 리디렉션 응답 전달
## 4. 마무리
### 추가 고려 사항
1. 처리율 제한 장치
	- 과다한 요청 발생 시 무력화 가능한 잠재적 보안 결함 존재
	- 처리율 제한 장치를 통해 IP 주소 등의 필터링 규칙으로 요청 필터링
2. 웹 서버 규모 확장: 본 설계의 웹 계층은 무상태 계층이므로, 웹 서버 증설 / 삭제 가능
3. 데이터베이스 규모 확장: 데이터베이스 다중화 / 샤딩을 통해 규모 확장성 달성 가능
4. 데이터 분석 솔루션:
	- URL 단축기를 통해 수집된 데이터를 활용하여 데이터 분석 솔루션 통합
	- 링크 클릭 수, 링크 클릭 시간대 등의 중요 비즈니스 정보 수집
5. 가용성, 데이터 일관성, 안정성: 이를 달성하기 위해 기본적인 대규모 시스템 설계 기법(1장) 활용